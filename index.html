<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Ïù∏ÌÑ∞ÎûôÌã∞Î∏å Ïä§ÌÜ†Î¶¨</title>
    <style>
        #nextBtn {
            margin-top: 10px;
            display: none;
        }

        .choiceBtn {
            display: block;
            margin: 5px 0;
            padding: 10px;
            background-color: #eee;
            border: 1px solid #aaa;
            cursor: pointer;
            width: fit-content;
        }
    </style>
</head>

<body>
    <h2>üìÑ ÌååÏùº ÎÇ¥Ïö©</h2>
    <pre id="output">Î∂àÎü¨Ïò§Îäî Ï§ë...</pre>
    <button id="nextBtn">Îã§Ïùå</button>
    <div id="choices"></div>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const filePath = params.get('file');
            const flag = params.get('flag');
            const now = params.get('now');

            const output = document.getElementById('output');
            const nextBtn = document.getElementById('nextBtn');
            const choicesDiv = document.getElementById('choices');

            let pages = [];
            let currentPage = 0;

            function showPage(index) {
                while (index < pages.length) {
                    const page = pages[index].trim();

                    // $CHOICE$Í∞Ä Ìè¨Ìï®Îêú ÌéòÏù¥ÏßÄÎùºÎ©¥ Î≥∏Î¨∏Í≥º ÏÑ†ÌÉùÏßÄÎ•º Î∂ÑÎ¶¨
                    if (page.includes('$CHOICE$')) {
                        const lines = page.split('\n');
                        const mainLines = [];
                        const choiceLines = [];

                        for (const line of lines) {
                            if (line.trim().startsWith('$CHOICE$')) {
                                choiceLines.push(line.trim());
                            } else {
                                mainLines.push(line.trim());
                            }
                        }

                        // Î≥∏Î¨∏ Ï∂úÎ†•
                        output.textContent = mainLines.join('\n');
                        nextBtn.style.display = 'none';
                        showChoices(choiceLines);
                        return;
                    }

                    if (page === '') {
                        index++;
                        currentPage = index;
                        continue;
                    }

                    if (page.includes('$END$')) {
                        // ÏûêÎèô Î∂ÑÍ∏∞ Ï≤òÎ¶¨
                        processRandomFlagJump(flag, now);
                        return;
                    }
                    return;
                }

                nextBtn.style.display = 'none';
            }

            function processRandomFlagJump(flag, now) {
                const zeroIndices = [];
                for (let i = 0; i < flag.length; i++) {
                    if (flag[i] === '0') zeroIndices.push(i);
                }

                if (zeroIndices.length === 0) return; // 0Ïù¥ ÏóÜÏúºÎ©¥ ÏïÑÎ¨¥ Í≤ÉÎèÑ ÌïòÏßÄ ÏïäÏùå

                const randomIndex = zeroIndices[Math.floor(Math.random() * zeroIndices.length)];

                // flag Î¨∏ÏûêÏó¥ÏóêÏÑú Ìï¥Îãπ ÏúÑÏπòÎßå 1Î°ú Î∞îÍæ∏Í∏∞
                const newFlagArray = flag.split('');
                newFlagArray[randomIndex] = '1';
                const newFlag = newFlagArray.join('');

                // epx Í≤ΩÎ°ú Íµ¨ÏÑ±
                const newFilePath = `data/side/ep${randomIndex}/main.txt`;

                // URL ÏÉùÏÑ± Î∞è Ïù¥Îèô
                const nextURL = `index.html?file=${encodeURIComponent(newFilePath)}&flag=${newFlag}&now=${randomIndex}`;
                window.location.href = nextURL;
            }

            function mergeFlags(currentFlag, textFlag) {
                if (currentFlag.length !== textFlag.length) {
                    console.error("FLAG Í∏∏Ïù¥ Î∂àÏùºÏπò");
                    return currentFlag;
                }

                const merged = currentFlag.split('').map((char, i) => {
                    return textFlag[i] !== '0' ? textFlag[i] : char;
                });

                return merged.join('');
            }

            function showChoices(choiceLines) {
                choicesDiv.innerHTML = '';
                for (const line of choiceLines) {
                    if (!line.startsWith('$CHOICE$$')) continue;

                    const parts = line.replace('$CHOICE$$', '').split('$');
                    if (parts.length < 2) continue;

                    const file = parts[0].trim();       // ex: side/ep1/choice1.txt
                    const label = parts[1].trim();      // ex: ÎßàÎ≤ï ÏóÜÏù¥ Î¨∏Ï†úÎ•º Ìï¥Í≤∞ÌïòÎ†§ ÌïúÎã§.

                    const newURL = `index.html?file=${encodeURIComponent(file)}&flag=${flag}&now=${now}`;

                    const btn = document.createElement('button');
                    btn.textContent = label;
                    btn.className = 'choiceBtn';
                    btn.addEventListener('click', () => {
                        window.location.href = newURL;
                    });

                    choicesDiv.appendChild(btn);
                }
            }


            if (filePath) {
                fetch(filePath)

                    .then(res => {
                        if (!res.ok) throw new Error('ÌååÏùºÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§');
                        return res.text();
                    })
                    .then(text => {
                        const flagFromText = (text.match(/\$FLAG\$(\d{10})/) || [])[1];
                        if (flagFromText) {
                            flag = mergeFlags(flag, flagFromText);  // flagÎäî Ï†ÑÏó≠ Î≥ÄÏàò ÎòêÎäî URL ÌååÎùºÎØ∏ÌÑ∞Î°ú Î∞õÏùÄ Í∞í
                        }
                        pages = text.split('$NEXT$').map(s => s.trim()).filter(s => s.length > 0);
                        showPage(currentPage);
                    })
                    .catch(err => {
                        output.textContent = `ÏóêÎü¨: ${err.message}`;
                    });
            } else {
                output.textContent = 'file ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.';
            }

            nextBtn.addEventListener('click', () => {
                currentPage++;
                showPage(currentPage);
            });
        });
    </script>
</body>

</html>